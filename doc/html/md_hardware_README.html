<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>sketchbook: Setup the Arduino IDE for picorv32</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">sketchbook
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Setup the Arduino IDE for picorv32 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This hardware and code was build and tested using icestudio (icestorm) and an Alhambra II board. It should work out of the box or be fairly easy to adopt to other similar boards (e.g. TinyFPGA, iCEBreaker, etc.).</p>
<div class="image">
<img src="https://raw.githubusercontent.com/drtrigon/fpgarduino-icestorm/master/AlhambraII/picorv32/variants/AlhambraII/gpio_adc_hardware.png"  alt="gpio_adc_hardware.png"/>
</div>
<h3>1.) unpack (clone) this archive (repo) to ~/sketchbook/hardware/</h3>
<pre class="fragment">$ cd ~/sketchbook/hardware/
$ wget https://github.com/drtrigon/fpgarduino-icestorm/archive/master.zip
$ unzip master.zip
$ mv fpgarduino-icestorm-master/AlhambraII .
$ rm -rf fpgarduino-icestorm-master
</pre><p>or clone </p>
<pre class="fragment">$ cd ~/sketchbook/hardware/
$ git clone https://github.com/drtrigon/fpgarduino-icestorm
$ mv fpgarduino-icestorm/AlhambraII .
$ rm -rf fpgarduino-icestorm
</pre><h3>2.) follow <a href="https://github.com/cliffordwolf/picorv32#building-a-pure-rv32i-toolchain">https://github.com/cliffordwolf/picorv32#building-a-pure-rv32i-toolchain</a></h3>
<pre class="fragment"># Ubuntu packages needed:
sudo apt-get install autoconf automake autotools-dev curl libmpc-dev \
    libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo \
    gperf libtool patchutils bc zlib1g-dev git libexpat1-dev

sudo mkdir ~/sketchbook/hardware/AlhambraII/picorv32/tools/riscv32i
sudo chown $USER ~/sketchbook/hardware/AlhambraII/picorv32/tools/riscv32i

git clone https://github.com/riscv/riscv-gnu-toolchain riscv-gnu-toolchain-rv32i
cd riscv-gnu-toolchain-rv32i
git checkout c3ad555
git submodule update --init --recursive

mkdir build; cd build
../configure --with-arch=rv32i --prefix=$HOME/sketchbook/hardware/AlhambraII/picorv32/tools/riscv32i
make -j$(nproc)
</pre><p>Now the Arduino IDE replaces the Makefile used before to compile and upload the firmware.</p>
<p>This DOES NOT use a bootloader, the compiled code is uploaded and executed directly. If you want to use a bootloader for uploading consider [9,10,5] (and [7] too).</p>
<p>In other words: In the Arduino IDE this is like uploading a "bootloader" to Arduino/AVR (does not use a bootloader but ISP e.g.). Uploading a "sketch" as the Arduino IDE usualy does (via bootloader) is done within the projects referred before (FPGArduino and "Programming the TinyFPGA BX with Arduino").</p>
<p>In Arduino IDE "Tools" pulldown menu, select: </p>
<pre class="fragment">Board: Alhambra II Generic picorv32
Port: (of the 2 available it's typically the second one, e.g. /dev/ttyUSB1)
Programmer: iceprog (Icestudio/Icestorm)
</pre><p>Note: The port needs to be set if using the Serial Montor only. For the programming it has no effect. Note: Forgetting to set the correct programmer results in a java error.</p>
<h3>3.) OPTIONAL: use iceprog directly from installed icestudio and its toolchain:</h3>
<pre class="fragment">cd ~/sketchbook/hardware/AlhambraII/picorv32/tools/iceprog/
rm iceprog
ln -s ~/.icestudio/apio/packages/toolchain-icestorm/bin/iceprog iceprog
</pre><p>or alternatively you can set the following line in platform.txt: </p>
<pre class="fragment">tools.iceprog.path={runtime.platform.path}/../../../../.icestudio/apio/packages/toolchain-icestorm/bin
</pre><h3>4.) INFORMATION: The bitstream to use is stored in $HOME/sketchbook/hardware/AlhambraII/picorv32/variants/AlhambraII/</h3>
<p>The bitstream can be programmed using: $ iceprog hardware.bin</p>
<p>This bitstream was derived from GPIO_ADC-recent-picorv32.zip using icestudio 0.3.3 (linux64.AppImage).</p>
<p>What does work:</p>
<ul>
<li>Verify (building)</li>
<li>Upload</li>
<li>Serial Monitor using any baudrate, default is 115200 (needs setting the correct port)</li>
<li>Arduino IDE examples:<ul>
<li>01.Basics<ul>
<li>BareMinimum: (compiles)</li>
<li>Blink: pinMode dummy for leds, digitalWrite on leds also using full 8-bit uint8_t, delay</li>
<li>DigitalReadSerial: Serial.println, Serial.begin all baudrates, pinMode (0-7), digitalRead (0-15)</li>
<li>AnalogReadSerial: analogRead (A0, 4Hz, bits increased from 8 to 10 by multiplying with 4)</li>
<li>ReadAnalogVoltage: (voltage calculation wrong 5.0-&gt;3.3)</li>
<li>Fade: analogWrite (PWM0 shares pin through OR with LED0, a digitalWrite(LED_BUILTIN, HIGH) "disables" the PWM0 - check hardware - currently pin is ignored as there is only one - also fixed digital output pins are shared and thus disabled or debug when using PWM0)</li>
</ul>
</li>
<li>02.Digital<ul>
<li>BlinkWithoutDelay: millis, micros, (delay refactored to use micros)</li>
<li>Button: (works after changing ledPin 13-&gt;LED_BUILTIN)</li>
<li>Debounce: (works after changing ledPin 13-&gt;LED_BUILTIN)</li>
<li>StateChangeDetection: (works after changing ledPin 13-&gt;LED_BUILTIN)</li>
<li>(TODO: DigitalInputPullup, tone...)</li>
</ul>
</li>
<li>03.Analog<ul>
<li>AnalogInput: (works after changing ledPin 13-&gt;LED_BUILTIN)</li>
<li>Smoothing: (works)</li>
<li>AnalogInOutSerial: map</li>
<li>Calibration: (works)</li>
<li>Fading: (works)</li>
<li>(AnalogWriteMega could also be implemented)</li>
</ul>
</li>
<li>04.Communication<ul>
<li>ASCIITable: (works)</li>
<li>Graph: (works)</li>
<li>VirtualColorMixer: (works with A0 only, A1 and A2 always read 0)</li>
<li>Dimmer: Serial.available, Serial.read, Serial._rx_complete_irq</li>
<li>PhysicalPixel: (works)</li>
<li>SerialCallResponse: (works but the function "establishContact* needs to be declared before "setup" and needs Serial._rx_complete_irq(); within the loop)
    * SerialCallResponseASCII: (works but the function "establishContact* needs to be declared before "setup" and needs Serial._rx_complete_irq(); within the loop)</li>
<li>(TODO: ReadASCIIString - parseInt from Stream class, SerialEvent)</li>
</ul>
</li>
<li>05.Control<ul>
<li>IfStatementConditional: (works after changing ledPin 13-&gt;LED_BUILTIN)</li>
<li>switchCase: (works)</li>
<li>WhileStatementConditional: (works after changing indicatorLedPin 13-&gt;LED_BUILTIN and buttonPin 2-&gt;14, also the function "calibrate" needs to be declared before "loop")</li>
<li>Array: digitalWrite (for gpio and fixed pins)</li>
<li>ForLoopIteration: (works)</li>
<li>switchCase2: (works)</li>
</ul>
</li>
<li>11.ArduinoISP<ul>
<li>(TODO: BitBanged/software SPI, USE_OLD_STYLE_WIRING, RESET/PIN_MOSI/PIN_MISO/PIN_SCK/etc. to use gpio (0-7), needs delayMicroseconds - see comment below ...)</li>
</ul>
</li>
<li>Other Libraries:<ul>
<li>SSD1306Ascii: SoftSpi128x64 (compiles, not tested - size big; 157988 - need hardware for testing)</li>
<li>(TODO: PJON ???)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>TODO:</h3>
<p>TODO: spi with external hardware like oled, etc.</p>
<p>(TODO: add support for String class) (TODO: serial input drops/misses chars when e.g. transmitting "abcde" - not interrupt based) (TODO: add travis integration in order to automatically check whether all examples compile and link properly - functional check has to be done manually) (TODO: virtual functions around <a class="el" href="classPrint.html">Print(::write)</a> do not work...) (TODO: remove "picorv32: work-a-round" and adopt to arduino template where possible) (TODO: gpio with switchable/dynamic pull-up only possible with SB_IO_I3C (rare on some pins only) or 2 pins <a href="https://stackoverflow.com/questions/56517923/ice40-icestorm-fpga-switchable-pullup-on-bi-directional-io-pins/">https://stackoverflow.com/questions/56517923/ice40-icestorm-fpga-switchable-pullup-on-bi-directional-io-pins/</a> ) (TODO: code loading and execution way to slow for delayMicroseconds - a single line of assembler code takes around 200 cycles or 16-21 us - reason is slow spi flash as memory - solution is faster memory, "[...] create a cache. Or you can just copy all performance-critical code to 
          RAM, or execute from a ROM." <a href="https://github.com/cliffordwolf/picorv32/issues/126">https://github.com/cliffordwolf/picorv32/issues/126</a> ) (TODO: bitbang I2C w/o using interrupts needs delayMicroseconds - solution add I2C hardware <a href="https://github.com/felias-fogg/SlowSoftWire,">https://github.com/felias-fogg/SlowSoftWire,</a> <a href="https://github.com/felias-fogg/SlowSoftI2CMaster">https://github.com/felias-fogg/SlowSoftI2CMaster</a> )</p>
<h3>Further info:</h3>
<ul>
<li>[1] <a href="https://github.com/riscv/riscv-tools">https://github.com/riscv/riscv-tools</a></li>
<li>[2] <a href="https://github.com/riscv/riscv-wiki/wiki/RISC-V-Software-Status">https://github.com/riscv/riscv-wiki/wiki/RISC-V-Software-Status</a></li>
<li>[3] <a href="https://github.com/FPGAwars/Alhambra-II-FPGA/tree/master/examples/picorv32/picosoc">https://github.com/FPGAwars/Alhambra-II-FPGA/tree/master/examples/picorv32/picosoc</a> (old, including icestudio project)</li>
<li>[4] <a href="https://github.com/cliffordwolf/picorv32">https://github.com/cliffordwolf/picorv32</a> (recent)</li>
<li>[5] <a href="http://www.nxlab.fer.hr/fpgarduino/">http://www.nxlab.fer.hr/fpgarduino/</a></li>
<li>[6] <a href="https://github.com/arduino/Arduino/wiki/Arduino-IDE-1.5-3rd-party-Hardware-specification">https://github.com/arduino/Arduino/wiki/Arduino-IDE-1.5-3rd-party-Hardware-specification</a></li>
<li>[7] <a href="https://github.com/f32c/arduino/issues/32">https://github.com/f32c/arduino/issues/32</a></li>
<li>[8] <a href="https://github.com/FPGAwars/icestudio/issues/321">https://github.com/FPGAwars/icestudio/issues/321</a></li>
<li>[9] <a href="https://discourse.tinyfpga.com/t/programming-the-tinyfpga-bx-with-arduino/898">https://discourse.tinyfpga.com/t/programming-the-tinyfpga-bx-with-arduino/898</a></li>
<li>[10] <a href="https://github.com/emard/prjtrellis-picorv32">https://github.com/emard/prjtrellis-picorv32</a> (mentioned in [7,9]) </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Jun 24 2019 21:30:39 for sketchbook by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
